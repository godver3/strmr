{{template "base" .}}

{{define "title"}}Dashboard - {{if .IsAdmin}}strmr Admin{{else}}strmr account{{end}}{{end}}

{{define "content"}}
<div class="page-header" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
        <h1>Dashboard</h1>
        <p>Real-time monitoring and overview of your strmr server</p>
    </div>
    <button class="btn btn-secondary" onclick="refreshStatus()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"/>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
        Refresh
    </button>
</div>

<!-- Connection Status -->
<div class="grid {{if .IsAdmin}}grid-4{{else}}grid-2{{end}}" style="margin-bottom: 1.5rem;">
    <div class="stat-card">
        <div class="stat-label">Backend</div>
        <div class="stat-value" id="backendStatus">
            {{if .Status.BackendReachable}}
            <span class="status-badge online"><span class="status-dot"></span> Online</span>
            {{else}}
            <span class="status-badge offline"><span class="status-dot"></span> Offline</span>
            {{end}}
        </div>
        {{if .IsAdmin}}<div class="stat-subtext">http://{{.Settings.Server.Host}}:{{.Settings.Server.Port}}</div>{{end}}
    </div>

    <div class="stat-card">
        <div class="stat-label">Active Streams</div>
        <div class="stat-value" id="activeStreamCount">-</div>
        <div class="stat-subtext" id="streamSubtext">Loading...</div>
    </div>

    {{if .IsAdmin}}
    <div class="stat-card">
        <div class="stat-label">Service Mode</div>
        <div class="stat-value" style="font-size: 1rem;">{{.Settings.Streaming.ServiceMode}}</div>
        <div class="stat-subtext">Priority: {{.Settings.Streaming.ServicePriority}}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Transmux</div>
        <div class="stat-value" style="font-size: 1rem;">
            {{if .Settings.Transmux.Enabled}}
            <span class="status-badge online"><span class="status-dot"></span> Enabled</span>
            {{else}}
            <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
            {{end}}
        </div>
        <div class="stat-subtext">{{.Settings.Transmux.FFmpegPath}}</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Cache Limit</div>
        <div class="stat-value">{{.Settings.Streaming.MaxCacheSizeMB}} MB</div>
        <div class="stat-subtext">{{.Settings.Streaming.MaxDownloadWorkers}} workers</div>
    </div>
    {{end}}
</div>

<!-- Active Streams -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            Active Streams
        </h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div class="view-toggle" style="display: flex; background: var(--bg-tertiary); border-radius: var(--radius); padding: 2px;">
                <button id="viewCardBtn" class="view-toggle-btn active" onclick="setStreamView('card')" title="Card View">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </button>
                <button id="viewTableBtn" class="view-toggle-btn" onclick="setStreamView('table')" title="Table View">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="refreshStreams()">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="streamsContainer">
            <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted);">
                <div class="spinner" style="margin-right: 0.5rem;"></div>
                Loading streams...
            </div>
        </div>
    </div>
</div>

{{if .IsAdmin}}
<!-- Service Health -->
<div class="grid grid-2" style="margin-bottom: 1.5rem;">
    <div class="card">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                Usenet Providers
            </h2>
        </div>
        <div class="card-body">
            <div id="usenetProviders">
                {{if .Settings.Usenet}}
                    {{range .Settings.Usenet}}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500;">{{.Name}}</div>
                            <div style="font-size: 0.8125rem; color: var(--text-muted);">
                                {{.Host}}:{{.Port}} {{if .SSL}}(SSL){{end}}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: right;">
                                <div style="font-weight: 500;">{{.Connections}}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">connections</div>
                            </div>
                            {{if .Enabled}}
                            <span class="status-badge online"><span class="status-dot"></span> Active</span>
                            {{else}}
                            <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                {{else}}
                    <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No providers configured</p>
                {{end}}
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.875rem;">
                    <span>Total Connections:</span>
                    <span style="font-weight: 600; color: var(--text-primary);">{{totalConnections .Settings.Usenet}}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                </svg>
                Debrid Providers
            </h2>
            <button class="btn btn-sm btn-secondary" onclick="refreshDebridStatus()">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
                Refresh
            </button>
        </div>
        <div class="card-body">
            <div id="debridProviders">
                {{if .Settings.Streaming.DebridProviders}}
                    {{range .Settings.Streaming.DebridProviders}}
                    <div class="debrid-provider-row" data-provider="{{.Provider}}" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500;">{{.Name}}</div>
                            <div style="font-size: 0.8125rem; color: var(--text-muted);">
                                {{.Provider}}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: right;" class="debrid-expiry-info">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                    {{if .APIKey}}API Key Set{{else}}No API Key{{end}}
                                </div>
                            </div>
                            {{if .Enabled}}
                            <span class="status-badge online"><span class="status-dot"></span> Active</span>
                            {{else}}
                            <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                {{else}}
                    <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No providers configured</p>
                {{end}}
            </div>
        </div>
    </div>
</div>
{{end}}

{{if .IsAdmin}}
<!-- Endpoint Health -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Endpoint Health
        </h2>
        <button class="btn btn-sm btn-secondary" onclick="testEndpoints()">Test All</button>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Response Time</th>
                    </tr>
                </thead>
                <tbody id="endpointResults">
                    <tr>
                        <td>/health</td>
                        <td>GET</td>
                        <td id="health-status">-</td>
                        <td id="health-time">-</td>
                    </tr>
                    <tr>
                        <td>Settings API</td>
                        <td>GET</td>
                        <td id="settings-status">-</td>
                        <td id="settings-time">-</td>
                    </tr>
                    <tr>
                        <td>Status API</td>
                        <td>GET</td>
                        <td id="status-status">-</td>
                        <td id="status-time">-</td>
                    </tr>
                    <tr>
                        <td>Profiles API</td>
                        <td>GET</td>
                        <td id="profiles-status">-</td>
                        <td id="profiles-time">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Configuration Summary -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Configuration Summary
        </h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Value</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Server Port</td>
                        <td>{{.Settings.Server.Port}}</td>
                        <td style="color: var(--text-muted);">HTTP API port</td>
                    </tr>
                    <tr>
                        <td>Download Workers</td>
                        <td>{{.Settings.Streaming.MaxDownloadWorkers}}</td>
                        <td style="color: var(--text-muted);">Maximum concurrent download workers</td>
                    </tr>
                    <tr>
                        <td>Cache Size</td>
                        <td>{{.Settings.Streaming.MaxCacheSizeMB}} MB</td>
                        <td style="color: var(--text-muted);">Maximum cache size</td>
                    </tr>
                    <tr>
                        <td>WebDAV</td>
                        <td>
                            {{if .Settings.WebDAV.Enabled}}
                            <span class="status-badge online"><span class="status-dot"></span> Enabled</span>
                            {{else}}
                            <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
                            {{end}}
                        </td>
                        <td style="color: var(--text-muted);">{{.Settings.WebDAV.Prefix}}</td>
                    </tr>
                    <tr>
                        <td>Metadata Cache TTL</td>
                        <td>{{.Settings.Cache.MetadataTTLHours}} hours</td>
                        <td style="color: var(--text-muted);">Metadata cache duration</td>
                    </tr>
                    <tr>
                        <td>Live TV Playlist</td>
                        <td>
                            {{if or .Settings.Live.PlaylistURL (and (eq .Settings.Live.Mode "xtream") .Settings.Live.XtreamHost .Settings.Live.XtreamUsername)}}
                            <span class="status-badge online"><span class="status-dot"></span> {{if eq .Settings.Live.Mode "xtream"}}Xtream{{else}}M3U{{end}} Configured</span>
                            {{else}}
                            <span class="status-badge offline"><span class="status-dot"></span> Not Set</span>
                            {{end}}
                        </td>
                        <td style="color: var(--text-muted);">{{if eq .Settings.Live.Mode "xtream"}}Xtream Codes{{else}}M3U playlist{{end}} for Live TV</td>
                    </tr>
                    <tr>
                        <td>Indexers</td>
                        <td>{{countEnabledIndexers .Settings.Indexers}} / {{len .Settings.Indexers}}</td>
                        <td style="color: var(--text-muted);">Active indexers</td>
                    </tr>
                    <tr>
                        <td>Torrent Scrapers</td>
                        <td>{{countEnabledScrapers .Settings.TorrentScrapers}} / {{len .Settings.TorrentScrapers}}</td>
                        <td style="color: var(--text-muted);">Active torrent scrapers</td>
                    </tr>
                    <tr>
                        <td>Content Filtering</td>
                        <td>
                            {{if hasFiltering .Settings.Filtering}}
                            <span class="status-badge warning"><span class="status-dot"></span> Active</span>
                            {{else}}
                            <span class="status-badge online"><span class="status-dot"></span> None</span>
                            {{end}}
                        </td>
                        <td style="color: var(--text-muted);">
                            {{if .Settings.Filtering.FilterOutTerms}}
                            Filtering: {{join .Settings.Filtering.FilterOutTerms ", "}}
                            {{end}}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Indexers and Scrapers -->
<div class="grid grid-2" style="margin-bottom: 1.5rem;">
    <div class="card">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                Indexers
            </h2>
            <a href="{{$.BasePath}}/settings#indexers" class="btn btn-sm btn-secondary">Edit</a>
        </div>
        <div class="card-body">
            {{if .Settings.Indexers}}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Settings.Indexers}}
                        <tr>
                            <td>{{.Name}}</td>
                            <td>{{.Type}}</td>
                            <td>
                                {{if .Enabled}}
                                <span class="status-badge online"><span class="status-dot"></span> Enabled</span>
                                {{else}}
                                <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.875rem;">
                    <span>Total Indexers:</span>
                    <span style="font-weight: 600; color: var(--text-primary);">{{countEnabledIndexers .Settings.Indexers}} enabled / {{len .Settings.Indexers}} total</span>
                </div>
            </div>
            {{else}}
            <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No indexers configured</p>
            {{end}}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <path d="M22 7l-10 7L2 7"/>
                </svg>
                Torrent Scrapers
            </h2>
            <a href="{{$.BasePath}}/settings#torrentScrapers" class="btn btn-sm btn-secondary">Edit</a>
        </div>
        <div class="card-body">
            {{if .Settings.TorrentScrapers}}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Settings.TorrentScrapers}}
                        <tr>
                            <td>{{.Name}}</td>
                            <td>{{.Type}}</td>
                            <td>
                                {{if .Enabled}}
                                <span class="status-badge online"><span class="status-dot"></span> Enabled</span>
                                {{else}}
                                <span class="status-badge offline"><span class="status-dot"></span> Disabled</span>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.875rem;">
                    <span>Total Scrapers:</span>
                    <span style="font-weight: 600; color: var(--text-primary);">{{countEnabledScrapers .Settings.TorrentScrapers}} enabled / {{len .Settings.TorrentScrapers}} total</span>
                </div>
            </div>
            {{else}}
            <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No scrapers configured</p>
            {{end}}
        </div>
    </div>
</div>
{{end}}
{{end}}

{{define "scripts"}}
<style>
    /* View toggle buttons */
    .view-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 28px;
        background: transparent;
        border: none;
        border-radius: calc(var(--radius) - 2px);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    .view-toggle-btn:hover {
        color: var(--text-secondary);
        background: var(--bg-hover);
    }
    .view-toggle-btn.active {
        background: var(--accent);
        color: white;
    }
    .view-toggle-btn svg {
        stroke: currentColor;
    }
    .view-toggle-btn.active svg {
        stroke: white;
    }

    /* Media card grid */
    .stream-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    /* Mobile: poster-style cards in a 2-column grid */
    @media (max-width: 640px) {
        .stream-cards-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
    }

    /* Media card */
    .stream-card {
        background: var(--bg-tertiary);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stream-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px var(--shadow);
    }

    .stream-card-media {
        position: relative;
        aspect-ratio: 16 / 9;
        background: var(--bg-primary);
        overflow: hidden;
    }

    /* Mobile: poster aspect ratio (2:3) */
    @media (max-width: 640px) {
        .stream-card-media {
            aspect-ratio: 2 / 3;
        }
        .stream-card-content {
            padding: 0.625rem;
        }
        .stream-card-title {
            font-size: 0.8125rem;
        }
        .stream-card-subtitle {
            font-size: 0.75rem;
        }
        .stream-card-meta {
            font-size: 0.6875rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        .stream-card-badges {
            top: 0.375rem;
            right: 0.375rem;
        }
        .stream-card-badge {
            font-size: 0.5625rem;
            padding: 0.0625rem 0.25rem;
        }
        .stream-card-live-badge {
            font-size: 0.5625rem;
            padding: 0.125rem 0.375rem;
        }
        .stream-card-profile {
            bottom: 0.375rem;
            left: 0.375rem;
            font-size: 0.5625rem;
            padding: 0.125rem 0.375rem;
        }
        .stream-card-profile svg {
            width: 10px;
            height: 10px;
        }
    }
    .stream-card-poster {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .stream-card-poster-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
    }
    .stream-card-poster-placeholder svg {
        width: 48px;
        height: 48px;
        color: var(--text-muted);
        opacity: 0.5;
    }

    .stream-card-live-badge {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 4px;
        letter-spacing: 0.025em;
    }
    .stream-card-profile {
        position: absolute;
        bottom: 0.5rem;
        left: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        font-size: 0.6875rem;
        font-weight: 500;
        border-radius: 4px;
        backdrop-filter: blur(4px);
    }
    .stream-card-profile svg {
        opacity: 0.8;
    }
    .stream-card-live-badge::before {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: pulse-live 1.5s infinite;
    }
    @keyframes pulse-live {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .stream-card-badges {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }
    .stream-card-badge {
        padding: 0.125rem 0.375rem;
        font-size: 0.625rem;
        font-weight: 600;
        border-radius: 4px;
    }
    .stream-card-badge.dv {
        background: rgba(139, 92, 246, 0.9);
        color: white;
    }
    .stream-card-badge.hdr {
        background: rgba(245, 158, 11, 0.9);
        color: white;
    }
    .stream-card-badge.hls {
        background: rgba(34, 197, 94, 0.9);
        color: white;
    }
    .stream-card-badge.direct {
        background: rgba(99, 102, 241, 0.9);
        color: white;
    }

    .stream-card-content {
        padding: 0.875rem;
    }
    .stream-card-title {
        font-weight: 600;
        font-size: 0.9375rem;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .stream-card-subtitle {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .stream-card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .stream-card-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .stream-card-meta-item svg {
        width: 12px;
        height: 12px;
    }

    .stream-card-progress {
        height: 3px;
        background: var(--bg-primary);
        margin-top: 0.75rem;
        border-radius: 2px;
        overflow: hidden;
    }
    .stream-card-progress-bar {
        height: 100%;
        background: var(--accent);
        transition: width 0.3s;
    }
</style>
<script>
    const basePath = {{json .BasePath}};
    const isAdmin = {{json .IsAdmin}};

    // Stream view state
    let currentStreamView = localStorage.getItem('streamView') || 'card';
    let cachedStreams = [];
    const metadataCache = new Map();

    function setStreamView(view) {
        currentStreamView = view;
        localStorage.setItem('streamView', view);

        // Update button states
        document.getElementById('viewCardBtn').classList.toggle('active', view === 'card');
        document.getElementById('viewTableBtn').classList.toggle('active', view === 'table');

        // Re-render with cached streams
        if (cachedStreams.length > 0) {
            renderStreams(cachedStreams);
        }
    }

    async function testEndpoint(url, elementPrefix) {
        const statusEl = document.getElementById(elementPrefix+'-status');
        const timeEl = document.getElementById(elementPrefix+'-time');
        statusEl.innerHTML = '<div class="spinner" style="width: 14px; height: 14px;"></div>';
        timeEl.textContent = '-';
        try {
            const start = performance.now();
            const response = await fetch(url, {credentials: 'same-origin'});
            const duration = Math.round(performance.now() - start);
            timeEl.textContent = duration + 'ms';
            if (response.ok) {
                statusEl.innerHTML = '<span class="status-badge online"><span class="status-dot"></span> OK</span>';
            } else {
                statusEl.innerHTML = '<span class="status-badge warning"><span class="status-dot"></span> ' + response.status + '</span>';
            }
        } catch (e) {
            statusEl.innerHTML = '<span class="status-badge offline"><span class="status-dot"></span> Error</span>';
            timeEl.textContent = '-';
        }
    }

    async function testEndpoints() {
        await Promise.all([
            testEndpoint('/health', 'health'),
            testEndpoint(basePath + '/api/settings', 'settings'),
            testEndpoint(basePath + '/api/status', 'status'),
            testEndpoint(basePath + '/api/profiles', 'profiles')
        ]);
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
        if (!seconds || seconds < 0) return '-';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return mins + ':' + secs.toString().padStart(2, '0');
    }

    function getTimeSince(isoDate) {
        if (!isoDate) return '-';
        const date = new Date(isoDate);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return diffMins + 'm ago';
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return diffHours + 'h ago';
        return Math.floor(diffHours / 24) + 'd ago';
    }

    // Get media display info from stream data
    function getMediaInfo(stream) {
        // Use data from backend if available (from matched playback progress)
        if (stream.title) {
            if (stream.media_type === 'episode') {
                return {
                    title: stream.title,
                    subtitle: stream.episode_name
                        ? `S${stream.season_number}E${stream.episode_number} - ${stream.episode_name}`
                        : `Season ${stream.season_number}, Episode ${stream.episode_number}`,
                    type: 'series',
                    externalIds: stream.externalIds
                };
            } else {
                return {
                    title: stream.title,
                    subtitle: stream.year ? String(stream.year) : '',
                    type: 'movie',
                    externalIds: stream.externalIds
                };
            }
        }

        // Fallback: clean up filename for display only
        const filename = stream.filename || '';
        const name = filename.replace(/\.[^/.]+$/, '').replace(/[._]/g, ' ').replace(/\s+/g, ' ').trim();
        return { title: name || 'Unknown', subtitle: '', type: 'unknown', externalIds: null };
    }

    // Fetch poster using external IDs (tvdbId/tmdbId) directly
    async function fetchPoster(mediaInfo) {
        if (!mediaInfo.externalIds) return null;

        const cacheKey = JSON.stringify(mediaInfo.externalIds);
        if (metadataCache.has(cacheKey)) {
            return metadataCache.get(cacheKey);
        }

        try {
            const tvdbId = mediaInfo.externalIds.tvdb;
            const tmdbId = mediaInfo.externalIds.tmdb;
            const type = mediaInfo.type === 'series' ? 'series' : 'movie';

            // Build query params using IDs
            const params = new URLSearchParams();
            if (tvdbId) params.set('tvdbId', tvdbId);
            if (tmdbId) params.set('tmdbId', tmdbId);
            params.set('name', mediaInfo.title);

            // Use series-details or movie-details endpoint to get poster by ID
            const endpoint = type === 'series' ? 'metadata/series/details' : 'metadata/movie/details';
            const response = await fetch(basePath + `/api/${endpoint}?${params.toString()}`, {
                credentials: 'same-origin'
            });

            if (!response.ok) return null;

            const data = await response.json();
            const title = data.title || data;
            const poster = title.poster?.url || title.backdrop?.url || null;

            if (poster) {
                metadataCache.set(cacheKey, poster);
            }
            return poster;
        } catch (e) {
            console.warn('Failed to fetch poster:', e);
        }
        return null;
    }

    function getProfilesDisplay(stream) {
        // Use profile_names array if available, otherwise fall back to single profile_name
        const names = stream.profile_names || (stream.profile_name ? [stream.profile_name] : []) || (stream.profile_id ? [stream.profile_id] : []);
        if (names.length === 0) return '<span style="color: var(--text-muted);">-</span>';
        if (names.length === 1) return names[0];
        // Multiple profiles - show comma-separated
        return names.join(', ');
    }

    function renderTableView(streams) {
        return '<div class="table-container"><table><thead><tr><th>File</th><th>Profile(s)</th><th>Type</th><th>Progress</th><th>Transferred</th><th>Started</th></tr></thead><tbody>' +
            streams.map(stream => {
                const progress = stream.percent_watched || 0;
                const currentPos = stream.current_position || 0;
                const duration = stream.duration || 0;
                const timeDisplay = duration > 0 ? formatTime(currentPos) + ' / ' + formatTime(duration) : '-';
                return '<tr><td><div style="max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="'+(stream.path || stream.original_path || '-')+'">'+(stream.filename || (stream.path ? stream.path.split('/').pop() : '-'))+'</div>'+(stream.has_dv ? '<span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-size: 0.625rem; padding: 0.125rem 0.375rem;">DV</span>' : '')+(stream.has_hdr ? '<span class="status-badge" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; font-size: 0.625rem; padding: 0.125rem 0.375rem;">HDR</span>' : '')+'</td><td style="font-size: 0.8125rem;">'+getProfilesDisplay(stream)+'</td><td><span class="status-badge '+(stream.type === 'hls' ? 'online' : 'warning')+'">'+(stream.type || 'direct')+'</span></td><td style="font-size: 0.8125rem;"><div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 60px; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;"><div style="height: 100%; background: var(--accent); width: '+progress.toFixed(1)+'%;"></div></div><span style="font-weight: 500; min-width: 36px;">'+(progress > 0 ? progress.toFixed(0)+'%' : '-')+'</span></div><div style="font-size: 0.75rem; color: var(--text-muted);">'+timeDisplay+'</div></td><td>'+formatBytes(stream.bytes_streamed || 0)+'</td><td style="font-size: 0.8125rem; color: var(--text-muted);">'+getTimeSince(stream.created_at)+'</td></tr>';
            }).join('') +
            '</tbody></table></div>';
    }

    function formatTime(seconds) {
        if (!seconds || seconds < 0) return '0:00';
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        if (hours > 0) {
            return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getCardProfileDisplay(stream) {
        // Use profile_names array if available, otherwise fall back to single profile_name
        const names = stream.profile_names || (stream.profile_name ? [stream.profile_name] : []) || (stream.profile_id ? [stream.profile_id] : []);
        if (names.length === 0) return 'Unknown';
        if (names.length === 1) return names[0];
        // Multiple profiles - show count with tooltip
        return `<span title="${names.join(', ')}">${names.length} viewers</span>`;
    }

    function renderCardView(streams) {
        return '<div class="stream-cards-grid">' +
            streams.map((stream, idx) => {
                const mediaInfo = getMediaInfo(stream);
                const streamId = stream.id || idx;
                const progress = stream.percent_watched || 0;
                const hasProgress = progress > 0 || stream.duration > 0;
                const currentPos = stream.current_position || 0;
                const duration = stream.duration || 0;

                const profileDisplay = getCardProfileDisplay(stream);
                const profileNames = stream.profile_names || (stream.profile_name ? [stream.profile_name] : []) || [];
                const hasMultipleViewers = profileNames.length > 1;
                return `
                    <div class="stream-card" data-stream-id="${streamId}">
                        <div class="stream-card-media">
                            <div class="stream-card-poster-placeholder" id="poster-${streamId}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            <div class="stream-card-badges">
                                ${stream.has_dv ? '<span class="stream-card-badge dv">DV</span>' : ''}
                                ${stream.has_hdr ? '<span class="stream-card-badge hdr">HDR</span>' : ''}
                                <span class="stream-card-badge ${stream.type === 'hls' ? 'hls' : 'direct'}">${(stream.type || 'direct').toUpperCase()}</span>
                            </div>
                            <div class="stream-card-profile" ${hasMultipleViewers ? `title="${profileNames.join(', ')}"` : ''}>
                                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                                    ${hasMultipleViewers ?
                                        '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>' :
                                        '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'}
                                </svg>
                                ${profileDisplay}
                            </div>
                        </div>
                        <div class="stream-card-content">
                            <div class="stream-card-title" title="${mediaInfo.title}">${mediaInfo.title}</div>
                            <div class="stream-card-subtitle">${mediaInfo.subtitle || ''}</div>
                            <div class="stream-card-meta">
                                <span class="stream-card-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    ${duration > 0 ? formatTime(currentPos) + ' / ' + formatTime(duration) : getTimeSince(stream.created_at)}
                                </span>
                                <span class="stream-card-meta-item" style="font-weight: 500; color: var(--accent);">
                                    ${progress > 0 ? progress.toFixed(0) + '%' : '-'}
                                </span>
                            </div>
                            ${hasProgress ? `<div class="stream-card-progress"><div class="stream-card-progress-bar" style="width: ${progress.toFixed(1)}%"></div></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('') +
            '</div>';
    }

    async function loadStreamPosters(streams) {
        for (const stream of streams) {
            const mediaInfo = getMediaInfo(stream);
            const streamId = stream.id || streams.indexOf(stream);
            const posterEl = document.getElementById(`poster-${streamId}`);

            // Skip if no external IDs available (can't fetch poster without them)
            if (!posterEl || !mediaInfo.externalIds) continue;

            const poster = await fetchPoster(mediaInfo);
            if (poster) {
                posterEl.innerHTML = `<img class="stream-card-poster" src="${poster}" alt="${mediaInfo.title}" onerror="this.parentElement.innerHTML='<div class=\\'stream-card-poster-placeholder\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1.5\\'><polygon points=\\'5 3 19 12 5 21 5 3\\'/></svg></div>'">`;
            }
        }
    }

    function renderStreams(streams) {
        const container = document.getElementById('streamsContainer');

        if (currentStreamView === 'card') {
            container.innerHTML = renderCardView(streams);
            // Load posters asynchronously
            loadStreamPosters(streams);
        } else {
            container.innerHTML = renderTableView(streams);
        }
    }

    async function refreshStreams() {
        const container = document.getElementById('streamsContainer');
        const countEl = document.getElementById('activeStreamCount');
        const subtextEl = document.getElementById('streamSubtext');
        try {
            const response = await fetch(basePath + '/api/streams');
            const data = await response.json();
            if (data.error) {
                countEl.textContent = '-';
                subtextEl.textContent = 'Backend unavailable';
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Could not fetch streams</p><p style="font-size: 0.75rem; margin-top: 0.5rem;">'+data.error+'</p></div>';
                return;
            }
            const streams = data.streams || [];
            cachedStreams = streams;
            countEl.textContent = streams.length;
            const totalBandwidth = streams.reduce((sum, s) => sum + (s.bytes_streamed || 0), 0);
            subtextEl.textContent = totalBandwidth > 0 ? formatBytes(totalBandwidth) + ' total' : 'No active streams';
            if (streams.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;"><polygon points="5 3 19 12 5 21 5 3"/></svg><p>No active streams</p></div>';
                return;
            }
            renderStreams(streams);
        } catch (e) {
            countEl.textContent = '-';
            subtextEl.textContent = 'Error';
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Failed to load streams</p><p style="font-size: 0.75rem;">'+e.message+'</p></div>';
        }
    }

    async function refreshStatus() {
        try {
            const status = await apiCall(basePath + '/api/status');
            const backendEl = document.getElementById('backendStatus');
            if (status.backend_reachable) {
                backendEl.innerHTML = '<span class="status-badge online"><span class="status-dot"></span> Online</span>';
            } else {
                backendEl.innerHTML = '<span class="status-badge offline"><span class="status-dot"></span> Offline</span>';
            }
            await refreshStreams();
            showToast('Status refreshed');
        } catch (e) {
            showToast('Failed to refresh status', 'error');
        }
    }

    async function refreshDebridStatus() {
        const rows = document.querySelectorAll('.debrid-provider-row');
        rows.forEach(row => {
            const infoEl = row.querySelector('.debrid-expiry-info');
            if (infoEl) {
                infoEl.innerHTML = '<div class="spinner" style="width: 14px; height: 14px;"></div>';
            }
        });
        try {
            const response = await fetch(basePath + '/api/debrid-status');
            const data = await response.json();
            if (data.error) {
                rows.forEach(row => {
                    const infoEl = row.querySelector('.debrid-expiry-info');
                    if (infoEl) {
                        infoEl.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-muted);">Error loading</div>';
                    }
                });
                return;
            }
            const providers = data.providers || [];
            let rowIndex = 0;
            rows.forEach(row => {
                const provider = providers[rowIndex];
                const infoEl = row.querySelector('.debrid-expiry-info');
                if (infoEl && provider) {
                    if (provider.error) {
                        infoEl.innerHTML = '<div style="font-size: 0.75rem; color: #ef4444;" title="'+provider.error+'">Error</div>';
                    } else if (!provider.has_api_key) {
                        infoEl.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-muted);">No API Key</div>';
                    } else if (provider.premium_active) {
                        let expiryText = '';
                        if (provider.is_lifetime) {
                            expiryText = '<div style="font-size: 0.75rem; color: #22c55e;">Lifetime</div>';
                        } else if (provider.expires_at) {
                            const daysColor = provider.days_remaining <= 7 ? '#ef4444' : provider.days_remaining <= 30 ? '#f59e0b' : '#22c55e';
                            expiryText = '<div style="font-weight: 500; color: '+daysColor+';">'+provider.days_remaining+' days</div>' +
                                '<div style="font-size: 0.75rem; color: var(--text-muted);">Expires: '+provider.expires_at+'</div>';
                        } else {
                            expiryText = '<div style="font-size: 0.75rem; color: #22c55e;">Premium Active</div>';
                        }
                        if (provider.username || provider.email) {
                            expiryText = '<div style="font-size: 0.75rem; color: var(--text-secondary);">'+(provider.username || provider.email)+'</div>' + expiryText;
                        }
                        infoEl.innerHTML = expiryText;
                    } else {
                        infoEl.innerHTML = '<div style="font-size: 0.75rem; color: #ef4444;">No Premium</div>';
                    }
                }
                rowIndex++;
            });
        } catch (e) {
            rows.forEach(row => {
                const infoEl = row.querySelector('.debrid-expiry-info');
                if (infoEl) {
                    infoEl.innerHTML = '<div style="font-size: 0.75rem; color: var(--text-muted);">Error</div>';
                }
            });
        }
    }

    setInterval(() => { refreshStreams(); }, 10000);

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize view toggle buttons based on saved preference
        setStreamView(currentStreamView);
        refreshStreams();
        if (isAdmin) {
            testEndpoints();
            refreshDebridStatus();
        }
    });
</script>
{{end}}
