{{template "base" .}}

{{define "title"}}Watch History - strmr Admin{{end}}

{{define "content"}}
<div class="page-header" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1>Watch History</h1>
        <p>View watch history by profile</p>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <select id="profileSelect" class="form-select" style="min-width: 200px;" onchange="loadHistory()">
            {{range .Users}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
        <button class="btn btn-secondary" onclick="loadHistory()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="1 4 1 10 7 10"/>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
            Refresh
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-4" style="margin-bottom: 1.5rem;">
    <div class="stat-card">
        <div class="stat-label">Movies Watched</div>
        <div class="stat-value" id="moviesWatched">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Episodes Watched</div>
        <div class="stat-value" id="episodesWatched">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Series In Progress</div>
        <div class="stat-value" id="seriesInProgress">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Last Activity</div>
        <div class="stat-value" id="lastActivity" style="font-size: 1rem;">-</div>
    </div>
</div>

<!-- Filter Tabs -->
<div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
    <button class="btn btn-primary filter-btn active" data-filter="all" onclick="filterHistory('all', this)">All</button>
    <button class="btn btn-secondary filter-btn" data-filter="movie" onclick="filterHistory('movie', this)">Movies</button>
    <button class="btn btn-secondary filter-btn" data-filter="episode" onclick="filterHistory('episode', this)">Episodes</button>
</div>

<!-- Watch History Table -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            Watch History
        </h2>
        <div id="historyCount" style="color: var(--text-muted); font-size: 0.875rem;">-</div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div id="historyContainer">
            <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted);">
                <div class="spinner" style="margin-right: 0.5rem;"></div>
                Loading watch history...
            </div>
        </div>
    </div>
</div>

<!-- Continue Watching -->
<div class="card">
    <div class="card-header">
        <h2>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            Continue Watching
        </h2>
    </div>
    <div class="card-body" style="padding: 0;">
        <div id="continueWatchingContainer">
            <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted);">
                <div class="spinner" style="margin-right: 0.5rem;"></div>
                Loading...
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    let allHistoryItems = [];
    let currentFilter = 'all';

    function getSelectedProfile() {
        return document.getElementById('profileSelect').value;
    }

    function formatDate(isoDate) {
        if (!isoDate) return '-';
        const date = new Date(isoDate);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return diffMins + ' min ago';
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return diffHours + 'h ago';
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays < 7) return diffDays + 'd ago';
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
    }

    function filterHistory(filter, btn) {
        currentFilter = filter;

        // Update button states
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('btn-primary', 'active');
            b.classList.add('btn-secondary');
        });
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary', 'active');

        renderHistory();
    }

    function renderHistory() {
        const container = document.getElementById('historyContainer');
        const countEl = document.getElementById('historyCount');

        let items = allHistoryItems;
        if (currentFilter !== 'all') {
            items = items.filter(item => item.mediaType === currentFilter);
        }

        countEl.textContent = items.length + ' items';

        if (items.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><p>No watch history found</p></div>';
            return;
        }

        container.innerHTML = '<div class="table-container"><table><thead><tr><th>Title</th><th>Type</th><th>Details</th><th>Watched At</th></tr></thead><tbody>' +
            items.map(item => {
                let title = item.name || item.movieName || item.seriesName || '-';
                let details = '';
                let typeBadge = '';

                if (item.mediaType === 'movie') {
                    typeBadge = '<span class="status-badge online">Movie</span>';
                    details = item.year ? String(item.year) : '-';
                } else if (item.mediaType === 'episode') {
                    typeBadge = '<span class="status-badge warning">Episode</span>';
                    if (item.seriesName) title = item.seriesName;
                    details = 'S' + String(item.seasonNumber || 0).padStart(2, '0') + 'E' + String(item.episodeNumber || 0).padStart(2, '0');
                    if (item.name && item.name !== item.seriesName) {
                        details += ' - ' + item.name;
                    }
                } else if (item.mediaType === 'series') {
                    typeBadge = '<span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: var(--accent);">Series</span>';
                    details = item.year ? String(item.year) : '-';
                } else {
                    typeBadge = '<span class="status-badge">' + (item.mediaType || 'Unknown') + '</span>';
                }

                return '<tr><td><div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + title + '">' + title + '</div></td><td>' + typeBadge + '</td><td style="color: var(--text-muted);">' + details + '</td><td style="font-size: 0.8125rem; color: var(--text-muted);">' + formatDate(item.watchedAt) + '</td></tr>';
            }).join('') +
            '</tbody></table></div>';
    }

    async function loadHistory() {
        const profileId = getSelectedProfile();
        const container = document.getElementById('historyContainer');
        const continueContainer = document.getElementById('continueWatchingContainer');

        // Show loading states
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted);"><div class="spinner" style="margin-right: 0.5rem;"></div>Loading watch history...</div>';
        continueContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--text-muted);"><div class="spinner" style="margin-right: 0.5rem;"></div>Loading...</div>';

        try {
            // Fetch watch history (using admin API with session auth)
            const historyResponse = await fetch('/admin/api/history/watched?userId=' + encodeURIComponent(profileId));
            if (!historyResponse.ok) {
                const errorText = await historyResponse.text();
                console.error('Watch history API error:', historyResponse.status, errorText);
                throw new Error('Failed to fetch watch history: ' + historyResponse.status + ' - ' + errorText);
            }
            const historyData = await historyResponse.json();
            allHistoryItems = historyData || [];

            // Sort by watchedAt descending
            allHistoryItems.sort((a, b) => {
                const dateA = a.watchedAt ? new Date(a.watchedAt) : new Date(0);
                const dateB = b.watchedAt ? new Date(b.watchedAt) : new Date(0);
                return dateB - dateA;
            });

            // Update stats
            const movies = allHistoryItems.filter(i => i.mediaType === 'movie');
            const episodes = allHistoryItems.filter(i => i.mediaType === 'episode');
            document.getElementById('moviesWatched').textContent = movies.length;
            document.getElementById('episodesWatched').textContent = episodes.length;

            // Last activity
            if (allHistoryItems.length > 0 && allHistoryItems[0].watchedAt) {
                document.getElementById('lastActivity').textContent = formatDate(allHistoryItems[0].watchedAt);
            } else {
                document.getElementById('lastActivity').textContent = '-';
            }

            // Render history
            renderHistory();

            // Fetch continue watching (using admin API with session auth)
            const continueResponse = await fetch('/admin/api/history/continue?userId=' + encodeURIComponent(profileId));
            if (!continueResponse.ok) {
                const errorText = await continueResponse.text();
                console.error('Continue watching API error:', continueResponse.status, errorText);
                throw new Error('Failed to fetch continue watching: ' + continueResponse.status + ' - ' + errorText);
            }
            const continueData = await continueResponse.json();
            const continueItems = continueData || [];

            document.getElementById('seriesInProgress').textContent = continueItems.length;

            if (continueItems.length === 0) {
                continueContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;"><polygon points="5 3 19 12 5 21 5 3"/></svg><p>No series in progress</p></div>';
            } else {
                continueContainer.innerHTML = '<div class="table-container"><table><thead><tr><th>Series</th><th>Last Watched</th><th>Next Episode</th><th>Updated</th></tr></thead><tbody>' +
                    continueItems.map(item => {
                        const lastWatched = item.lastWatched ? ('S' + String(item.lastWatched.seasonNumber || 0).padStart(2, '0') + 'E' + String(item.lastWatched.episodeNumber || 0).padStart(2, '0')) : '-';
                        const nextEp = item.nextEpisode ? ('S' + String(item.nextEpisode.seasonNumber || 0).padStart(2, '0') + 'E' + String(item.nextEpisode.episodeNumber || 0).padStart(2, '0')) : '-';
                        return '<tr><td><div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + (item.seriesTitle || '-') + '">' + (item.seriesTitle || '-') + '</div><div style="font-size: 0.75rem; color: var(--text-muted);">' + (item.year || '') + '</div></td><td>' + lastWatched + '</td><td style="color: var(--accent);">' + nextEp + '</td><td style="font-size: 0.8125rem; color: var(--text-muted);">' + formatDate(item.updatedAt) + '</td></tr>';
                    }).join('') +
                    '</tbody></table></div>';
            }

        } catch (e) {
            console.error('Error loading history:', e);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Failed to load watch history</p><p style="font-size: 0.75rem; margin-top: 0.5rem;">' + e.message + '</p></div>';
            continueContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Failed to load data</p></div>';

            // Reset stats on error
            document.getElementById('moviesWatched').textContent = '-';
            document.getElementById('episodesWatched').textContent = '-';
            document.getElementById('seriesInProgress').textContent = '-';
            document.getElementById('lastActivity').textContent = '-';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
    });
</script>
{{end}}
